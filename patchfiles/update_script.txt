#!/bin/bash

MAMECONFIG=$1
HARDWAREMODE_CURRENT=$2
TEMPLATEFILE=$3
RPI2JAMMA=$4
CONNECTION_TIMEOUT=30
UPDATED="N"
NOCHANGES="N"

ADVMAME_RC_PI2JAMMA=$(grep "advmame_rc_pi2jamma" "/tmp/patch_server.txt" | awk -F 'advmame_rc_pi2jamma=' '{print $2}' )
ADVMAME_RC_PI2SCART=$(grep "advmame_rc_pi2scart" "/tmp/patch_server.txt" | awk -F 'advmame_rc_pi2scart=' '{print $2}' )
TEMPLATE_UPDATE=$(grep "templatefile" "/tmp/patch_server.txt" | awk -F 'templatefile=' '{print $2}' )

case $HARDWAREMODE_CURRENT in
  Jamma )
    ADVMAME_RC_UPDATE="$ADVMAME_RC_PI2JAMMA"
  ;;
  SCART )
    ADVMAME_RC_UPDATE="$ADVMAME_RC_PI2SCART"
  ;;
esac

# Download default advmame.rc file
if ! [ -e /tmp/advmame_rc_update ]; then
  curl --connect-timeout $CONNECTION_TIMEOUT -k -L -o /tmp/advmame_rc_update "$ADVMAME_RC_UPDATE"
  response=$?
  if [ "$response" = "28" ] || [ ! -e "/tmp/advmame_rc_update" ]; then
    if [ "$response" = "28" ]; then
      dialog --timeout 15 --title "pinHP Arcade Classics" --msgbox "\n*** TIMEOUT ERROR ***\n\nCheck connection\n\n" 0 0
    else
      dialog --timeout 15 --title "pinHP Arcade Classics" --msgbox "\n*** ERROR ***\n\nFile not found:\nadvmame.rc\n\n" 0 0
    fi
  fi
fi

### Modelines update
if [ -e /tmp/advmame_rc_update ]; then

  touch /tmp/timings_current_names
  touch /tmp/timings_official
  touch /tmp/timings_missing
  cat $MAMECONFIG | grep device_video_modeline | awk -F"\"" '{print $2}' > /tmp/timings_current_names
  cat /tmp/advmame_rc_update | grep -v "^#" | grep device_video_modeline > /tmp/timings_official
  
  awk -v INPUTFILE="/tmp/timings_official" -v COMPAREFILE="/tmp/timings_current_names" -v OUTFILE="/tmp/timings_missing" -f "/root/scripts/missing_timings.awk"
  
  if grep -q "device_video_modeline" /tmp/timings_missing; then
  
    # Write missing timings into array
    cat /tmp/timings_missing | awk -F"\"" '{print $2}' > /tmp/timings_missing_names
    declare -a dialog_array
    i=1 # Array index
    j=1 # Visible menu item number to be displayed in menu list
    while read line
    do     
      dialog_array[ $i ]=$j
      (( j++ ))
      dialog_array[ ($i + 1) ]=$line
      (( i=($i+2) ))
    done < /tmp/timings_missing_names
  
    dummy=`dialog --timeout 30 --title "pinHP Arcade Classics" --menu "\nNew video modes" 0 0 0 "${dialog_array[@]}" 3>&1 1>&2 2>&3`
    if [ ! -z $dummy ]; then
      count_missing=$( cat /tmp/timings_missing | wc -l )
      dialog --timeout 15 --title "pinHP Arcade Classics" --defaultno --yesno "\nAdd $count_missing new modelines\nto current advmame.rc\nconfiguration file?\n\n" 0 0
      response=$?
      if [ "$response" = "0" ]; then
        rm /tmp/timings_insert_code &> /dev/null
        touch /tmp/timings_insert_code
        echo -e "\n# Added by online update" > /tmp/timings_insert_code
        cat /tmp/timings_missing >> /tmp/timings_insert_code
        echo "#" >> /tmp/timings_insert_code
        sed -i -e '/device_video_clock/r /tmp/timings_insert_code' $MAMECONFIG
  
        # Check if all lines were addded
        copycount=0
        while read line
        do
          if grep -q "$Line" "$MAMECONFIG"; then
            ((copycount++))
          fi
        done < /tmp/timings_missing
  
        if [ $count_missing -eq $copycount ]; then
          dialog --timeout 3 --title "pinHP Arcade Classics" --msgbox "\nSuccess!\n\n$copycount lines added\n\n" 0 0
          UPDATED="Y"
        else
          dialog --timeout 15 --title "pinHP Arcade Classics" --msgbox "\n*** ERROR ***\n\n$copycount/$count_missing lines added\n\n" 0 0
        fi
      else
        NOCHANGES="Y"
      fi
    fi
  fi
rm /tmp/timings_current_names &> /dev/null
rm /tmp/timings_official &> /dev/null
rm /tmp/timings_missing &> /dev/null
rm /tmp/timings_missing_names &> /dev/null
rm /tmp/timings_insert_code &> /dev/null
fi
  
### Update savestate input map
missing_code=""
missing_info=""
rm /tmp/missing_code &> /dev/null

if ! grep -q "input_map\[ui_save_state\]" $MAMECONFIG; then
  missing_info="input_map[ui_save_state]"
  grep "input_map\[ui_save_state\]" /tmp/advmame_rc_update >> /tmp/missing_code
fi
if ! grep -q "input_map\[ui_load_state\]" $MAMECONFIG; then
  missing_info="${missing_info}\ninput_map[ui_load_state]"
  grep "input_map\[ui_load_state\]" /tmp/advmame_rc_update >> /tmp/missing_code
fi

if [ ! -z "$missing_info" ]; then
  dialog --timeout 15 --title "pinHP Arcade Classics" --defaultno --yesno "\nAdd game savestate keys?\n\n$missing_info\n\n" 0 0
  response=$?
  if [ "$response" = "0" ]; then
    rm /tmp/insert_code &> /dev/null
    touch /tmp/insert_code
    echo -e "\n# Added by online update" > /tmp/insert_code
    cat /tmp/missing_code >> /tmp/insert_code
    echo "#" >> /tmp/insert_code
    if grep -q "^# mameconfig=." $MAMECONFIG; then
      sed -i -e '/^# mameconfig=./r /tmp/insert_code' $MAMECONFIG
    else
      sed -i -e '/DO NOT EDIT THIS LINE/r /tmp/insert_code' $MAMECONFIG
    fi            
    UPDATED="Y"
    dialog --timeout 3 --title "pinHP Arcade Classics" --msgbox "\nGame savestate keys\n\nDone!\n\n" 0 0
  else
    NOCHANGES="Y"
  fi
fi
  
### Update mouse/spinner support
missing_code=""
missing_info=""
rm /tmp/missing_code &> /dev/null

if ! grep -q "device.*mouse" $MAMECONFIG && ! grep -q "input_map.*mouse" $MAMECONFIG; then
  dialog --timeout 15 --title "pinHP Arcade Classics" --defaultno --yesno "\nAdd mouse/spinner support?\n\n" 0 0
  response=$?
  if [ "$response" = "0" ]; then
    rm /tmp/insert_code &> /dev/null
    touch /tmp/insert_code
    grep "device.*mouse" /tmp/advmame_rc_update >> /tmp/missing_code
    grep "input_map.*mouse" /tmp/advmame_rc_update >> /tmp/missing_code
    echo -e "\n# Added by online update" > /tmp/insert_code
    cat /tmp/missing_code >> /tmp/insert_code
    echo "#" >> /tmp/insert_code
    if grep -q "^# mameconfig=." $MAMECONFIG; then
      sed -i -e '/^# mameconfig=./r /tmp/insert_code' $MAMECONFIG
    else
      sed -i -e '/DO NOT EDIT THIS LINE/r /tmp/insert_code' $MAMECONFIG
    fi            
    UPDATED="Y"
    dialog --timeout 3 --title "pinHP Arcade Classics" --msgbox "\nMouse/spinner support\n\nDone!\n\n" 0 0
  else
    NOCHANGES="Y"
  fi
fi

### Update display_artwork_crop change to yes
if grep -q "^display_artwork_crop no" $MAMECONFIG; then
  dialog --timeout 30 --title "pinHP Arcade Classics" --defaultno --yesno "\nMAME setting, enabling artwork\nbackdrop to be displayed at\ncorrect game size\n\nCurrent setting:\n\n  'display_artwork_crop no'\n\nRecommended setting:\n\n  'display_artwork_crop yes'\n\nSet to 'yes'?\n\n" 0 0
  response=$?
  if [ "$response" = "0" ]; then
    sed -i 's/^display_artwork_crop no.*/display_artwork_crop yes/' $MAMECONFIG
    UPDATED="Y"
    dialog --timeout 3 --title "pinHP Arcade Classics" --msgbox "\nArtwork backdrop\n\nDone!\n\n" 0 0
  else
    NOCHANGES="Y"
  fi
fi

### Update _games.template
UPDATE_VERSION="27SEP21"

current_template_version=$( grep "version=" $TEMPLATEFILE | awk -F 'version=' '{print $2}' | grep -o "[0-9,A-Z,a-z]*" )
if [ -z "$current_template_version" ]; then
  current_template_version="unknown"
fi

if [ "$current_template_version" != "$UPDATE_VERSION" ]; then
  dialog --timeout 30 --title "pinHP Arcade Classics" --defaultno --yesno "\nGame definition file\n'_games.template'\n\nCurrent version: $current_template_version\nUpdate version:  $UPDATE_VERSION\n\nFavourites, saved in this\nfile, will be automatically\nbacked up and restored.\n\nCustom changes (game names\nor custom 'joy' parameter\nentries) will be set to the\nupdated default.\n\nDo you want to update?\n\n" 0 0
  response=$?
  if [ "$response" = "0" ]; then
    # Download _games.template
    clear
    if ! [ -e /tmp/template_update ]; then
      curl --connect-timeout $CONNECTION_TIMEOUT -k -L -o /tmp/template_update "$TEMPLATE_UPDATE"
      response=$?
      if [ "$response" = "28" ] || [ ! -e "/tmp/template_update" ]; then
        if [ "$response" = "28" ]; then
          dialog --timeout 15 --title "pinHP Arcade Classics" --msgbox "\n*** TIMEOUT ERROR ***\n\nCheck connection\n\n" 0 0
        else
          dialog --timeout 15 --title "pinHP Arcade Classics" --msgbox "\n*** ERROR ***\n\nFile not found:\n_games.template\n\n" 0 0
        fi
      fi
    fi
    if [ -e /tmp/template_update ]; then
  
      clear
      favcount=$( grep -E "(1ONE|1TWO|1TRE|0ALL|1FAV)" $TEMPLATEFILE | grep -v "_DUMMY" | wc -l )
      mkdir -p $RPI2JAMMA/backup/rpi2jamma/roms_advmame      
      cp  $TEMPLATEFILE $RPI2JAMMA/backup/rpi2jamma/roms_advmame/
  
      # Backup favourites         
      counter=0
      (
      # Set while loop until 100 %, simulation copy progress 
      while :
      do
cat <<EOF
XXX
$counter
\nBackup count:\n\n$favcount game definitions
XXX
EOF
      (( counter+=10 ))
      [ $counter -gt 100 ] && break
      sleep 0.05
      done
      ) |
      dialog --title "pinHP Arcade Classics" --gauge "Please wait" 10 26
      setterm -cursor off
      sleep 1
      # Backup end
      
      # Remove mario and pacman from default favourites
      sed -i 's/-0ONE-0TWO-0TRE-1ALL-1FAV/-0ONE-0TWO-0TRE-1ALL-0FAV/' /tmp/template_update
      cp /tmp/template_update $TEMPLATEFILE

      # Restore favourites
      FAVGAMES="/tmp/favgames.template"
      if [ -e "$RPI2JAMMA/backup/rpi2jamma/roms_advmame/_games.template" ]; then
        grep -E "(1ONE|1TWO|1TRE|0ALL|1FAV)" "$RPI2JAMMA/backup/rpi2jamma/roms_advmame/_games.template" | grep -v "_DUMMY" > "$FAVGAMES"
        favlines=$(cat "$FAVGAMES" | wc -l)
      fi
  
      if [ -e "$FAVGAMES" ] && [ "$favlines" -ne 0 ]; then
        default_params="-0ONE-0TWO-0TRE-1ALL-0FAV"
        cat $TEMPLATEFILE | grep -v \"_DUMMY\" | sed -i "s/params =\".*FAV\"/params =\"$default_params\"/g"
        dialog --title "pinHP Arcade Classics" --gauge "\n Restoring: $current_rom\n\n 0 / $favlines " 10 26 < <(
  
        i=0
        while read favline
        do
        # Calculate progress
        percent=$(( 100*(++i)/favlines ))

cat <<EOF
XXX
$percent
\n Restoring: $current_rom\n\n $i / $favlines
XXX
EOF
  
        current_rom=$( echo "$favline" | awk -F'"' '{print $2}' )
        backup_params=$( cat "$FAVGAMES" | grep "rom =\"$current_rom\"" | awk -F'"' '{print $6}' )
        sed -i "/rom =\"$current_rom\"/s/params =\".*FAV\"/params =\"$backup_params\"/" $TEMPLATEFILE 
        done < $FAVGAMES
  
        )
        setterm -cursor off
        sleep 1
      fi
      rm $FAVGAMES &> /dev/null
  
    fi
    UPDATED="Y"
    dialog --timeout 3 --title "pinHP Arcade Classics" --msgbox "\n_games.template\n\nDone!\n\n" 0 0
  else
    NOCHANGES="Y"
  fi
fi

rm /tmp/insert_code &> /dev/null

### Final confirmation dialog ###
if [ "$UPDATED" = "Y" ]; then
  dialog --timeout 15 --title "pinHP Arcade Classics" --msgbox "\nGame settings\n\nUpdate finished\n\n" 0 0
elif [ "$NOCHANGES" = "Y" ]; then
  dialog --timeout 15 --title "pinHP Arcade Classics" --msgbox "\nGame settings\n\nNo changes applied\n\n" 0 0
else
  dialog --timeout 15 --title "pinHP Arcade Classics" --msgbox "\nGame settings\n\n*** up to date ***\n\n" 0 0
fi

